{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Hyperparameter Tuning Results Analysis\n",
    "\n",
    "This notebook contains comprehensive hyperparameter tuning results for all models:\n",
    "- LSTM\n",
    "- MHSA (Multi-Head Self-Attention)\n",
    "- Pointer Network V45\n",
    "- Markov Baseline (no hyperparameter tuning)\n",
    "\n",
    "Each model is evaluated on two datasets:\n",
    "- **GeoLife**: Urban mobility dataset (constraint: max 500K parameters)\n",
    "- **DIY**: Larger trajectory dataset (constraint: max 3M parameters)\n",
    "\n",
    "All experiments up to 2025-12-27 are included."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "import json\n",
    "import os\n",
    "import glob\n",
    "import yaml\n",
    "import pandas as pd\n",
    "from datetime import datetime\n",
    "import warnings\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "pd.set_option('display.max_columns', None)\n",
    "pd.set_option('display.width', None)\n",
    "pd.set_option('display.max_colwidth', 50)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Helper Functions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_param_count(log_file):\n",
    "    \"\"\"Extract parameter count from training log\"\"\"\n",
    "    try:\n",
    "        with open(log_file, 'r') as f:\n",
    "            for line in f:\n",
    "                if 'Total trainable parameters:' in line:\n",
    "                    return int(line.split(':')[1].strip())\n",
    "    except:\n",
    "        pass\n",
    "    return None\n",
    "\n",
    "def read_json_results(json_file):\n",
    "    \"\"\"Read results from JSON file\"\"\"\n",
    "    try:\n",
    "        with open(json_file, 'r') as f:\n",
    "            return json.load(f)\n",
    "    except:\n",
    "        return None\n",
    "\n",
    "def read_config(config_file):\n",
    "    \"\"\"Read configuration from YAML file\"\"\"\n",
    "    try:\n",
    "        with open(config_file, 'r') as f:\n",
    "            return yaml.safe_load(f)\n",
    "    except:\n",
    "        return None\n",
    "\n",
    "def get_config_summary(config, model_type):\n",
    "    \"\"\"Generate a summary string of important config parameters\"\"\"\n",
    "    if not config:\n",
    "        return \"N/A\"\n",
    "    \n",
    "    params = []\n",
    "    \n",
    "    # Common parameters\n",
    "    if 'base_emb_size' in config:\n",
    "        params.append(f\"emb={config['base_emb_size']}\")\n",
    "    if 'batch_size' in config:\n",
    "        params.append(f\"bs={config['batch_size']}\")\n",
    "    if 'lr' in config:\n",
    "        params.append(f\"lr={config['lr']}\")\n",
    "    \n",
    "    # Model-specific parameters\n",
    "    if model_type == 'LSTM':\n",
    "        if 'lstm_hidden_size' in config:\n",
    "            params.append(f\"hidden={config['lstm_hidden_size']}\")\n",
    "        if 'lstm_num_layers' in config:\n",
    "            params.append(f\"layers={config['lstm_num_layers']}\")\n",
    "        if 'lstm_dropout' in config:\n",
    "            params.append(f\"lstm_drop={config['lstm_dropout']}\")\n",
    "        if 'fc_dropout' in config:\n",
    "            params.append(f\"fc_drop={config['fc_dropout']}\")\n",
    "    \n",
    "    elif model_type == 'MHSA':\n",
    "        if 'mhsa_num_layers' in config:\n",
    "            params.append(f\"layers={config['mhsa_num_layers']}\")\n",
    "        if 'mhsa_ff_dim' in config:\n",
    "            params.append(f\"ff={config['mhsa_ff_dim']}\")\n",
    "        if 'mhsa_num_heads' in config:\n",
    "            params.append(f\"heads={config['mhsa_num_heads']}\")\n",
    "        if 'mhsa_dropout' in config:\n",
    "            params.append(f\"drop={config['mhsa_dropout']}\")\n",
    "    \n",
    "    elif model_type == 'pointer_v45':\n",
    "        if 'pointer_hidden_dim' in config:\n",
    "            params.append(f\"hidden={config['pointer_hidden_dim']}\")\n",
    "        if 'pointer_num_layers' in config:\n",
    "            params.append(f\"layers={config['pointer_num_layers']}\")\n",
    "        if 'pointer_dropout' in config:\n",
    "            params.append(f\"drop={config['pointer_dropout']}\")\n",
    "    \n",
    "    return \", \".join(params)\n",
    "\n",
    "def extract_config_name(folder_name, config):\n",
    "    \"\"\"Try to extract a meaningful config name\"\"\"\n",
    "    if config and 'config_name' in config:\n",
    "        return config['config_name']\n",
    "    return folder_name\n",
    "\n",
    "def collect_experiment_data(exp_dir, model_name, dataset_name, max_date='20251227'):\n",
    "    \"\"\"Collect all experiment data for a given model and dataset\"\"\"\n",
    "    \n",
    "    pattern = f\"{dataset_name}_{model_name}_*\"\n",
    "    exp_folders = glob.glob(os.path.join(exp_dir, pattern))\n",
    "    \n",
    "    data = []\n",
    "    \n",
    "    for folder in sorted(exp_folders):\n",
    "        folder_name = os.path.basename(folder)\n",
    "        \n",
    "        # Extract datetime from folder name\n",
    "        parts = folder_name.split('_')\n",
    "        if len(parts) < 3:\n",
    "            continue\n",
    "        \n",
    "        datetime_str = parts[-1]\n",
    "        \n",
    "        # Filter by date\n",
    "        if datetime_str[:8] > max_date:\n",
    "            continue\n",
    "        \n",
    "        # Read files\n",
    "        config_file = os.path.join(folder, 'config.yaml')\n",
    "        val_results_file = os.path.join(folder, 'val_results.json')\n",
    "        test_results_file = os.path.join(folder, 'test_results.json')\n",
    "        log_file = os.path.join(folder, 'training.log')\n",
    "        \n",
    "        config = read_config(config_file)\n",
    "        val_results = read_json_results(val_results_file)\n",
    "        test_results = read_json_results(test_results_file)\n",
    "        param_count = get_param_count(log_file)\n",
    "        \n",
    "        if not val_results or not test_results:\n",
    "            continue\n",
    "        \n",
    "        # Format datetime\n",
    "        try:\n",
    "            dt = datetime.strptime(datetime_str, '%Y%m%d_%H%M%S')\n",
    "            formatted_dt = dt.strftime('%Y-%m-%d %H:%M:%S')\n",
    "        except:\n",
    "            formatted_dt = datetime_str\n",
    "        \n",
    "        # Create entry\n",
    "        entry = {\n",
    "            'folder_name': folder_name,\n",
    "            'datetime': formatted_dt,\n",
    "            'config_name': extract_config_name(folder_name, config),\n",
    "            'config_summary': get_config_summary(config, model_name),\n",
    "            'params': param_count,\n",
    "            'val_results': val_results,\n",
    "            'test_results': test_results,\n",
    "            'config': config\n",
    "        }\n",
    "        \n",
    "        data.append(entry)\n",
    "    \n",
    "    return data\n",
    "\n",
    "def derive_notes(exp_data, model_name, dataset_name):\n",
    "    \"\"\"Derive tuning notes based on chronological order and config changes\"\"\"\n",
    "    notes = []\n",
    "    \n",
    "    for i, exp in enumerate(exp_data):\n",
    "        if i == 0:\n",
    "            notes.append(\"Baseline configuration\")\n",
    "        else:\n",
    "            # Compare with previous to derive notes\n",
    "            prev_config = exp_data[i-1]['config']\n",
    "            curr_config = exp['config']\n",
    "            \n",
    "            changes = []\n",
    "            \n",
    "            if model_name == 'LSTM':\n",
    "                if curr_config.get('lstm_dropout') != prev_config.get('lstm_dropout'):\n",
    "                    changes.append(f\"dropout tuning\")\n",
    "                if curr_config.get('lr') != prev_config.get('lr'):\n",
    "                    changes.append(f\"LR adjustment\")\n",
    "                if curr_config.get('base_emb_size') != prev_config.get('base_emb_size'):\n",
    "                    changes.append(f\"embedding size change\")\n",
    "                if curr_config.get('lstm_hidden_size') != prev_config.get('lstm_hidden_size'):\n",
    "                    changes.append(f\"hidden size change\")\n",
    "                if curr_config.get('batch_size') != prev_config.get('batch_size'):\n",
    "                    changes.append(f\"batch size tuning\")\n",
    "            \n",
    "            elif model_name == 'MHSA':\n",
    "                if curr_config.get('base_emb_size') != prev_config.get('base_emb_size'):\n",
    "                    changes.append(f\"embedding size change\")\n",
    "                if curr_config.get('mhsa_num_layers') != prev_config.get('mhsa_num_layers'):\n",
    "                    changes.append(f\"layer depth change\")\n",
    "                if curr_config.get('mhsa_ff_dim') != prev_config.get('mhsa_ff_dim'):\n",
    "                    changes.append(f\"FF dimension tuning\")\n",
    "                if curr_config.get('lr') != prev_config.get('lr'):\n",
    "                    changes.append(f\"LR adjustment\")\n",
    "            \n",
    "            elif model_name == 'pointer_v45':\n",
    "                if curr_config.get('base_emb_size') != prev_config.get('base_emb_size'):\n",
    "                    changes.append(f\"embedding size change\")\n",
    "                if curr_config.get('pointer_num_layers') != prev_config.get('pointer_num_layers'):\n",
    "                    changes.append(f\"layer depth change\")\n",
    "                if curr_config.get('pointer_dropout') != prev_config.get('pointer_dropout'):\n",
    "                    changes.append(f\"dropout tuning\")\n",
    "                if curr_config.get('lr') != prev_config.get('lr'):\n",
    "                    changes.append(f\"LR adjustment\")\n",
    "            \n",
    "            if changes:\n",
    "                notes.append(\", \".join(changes).capitalize())\n",
    "            else:\n",
    "                notes.append(\"Fine-tuning iteration\")\n",
    "    \n",
    "    return notes\n",
    "\n",
    "def create_dataframe(exp_data, split='test', model_name='', dataset_name=''):\n",
    "    \"\"\"Create a dataframe from experiment data\"\"\"\n",
    "    \n",
    "    rows = []\n",
    "    notes = derive_notes(exp_data, model_name, dataset_name)\n",
    "    \n",
    "    for i, exp in enumerate(exp_data):\n",
    "        results = exp[f'{split}_results']\n",
    "        \n",
    "        row = {\n",
    "            'Config Name': exp['config_name'],\n",
    "            'Config': exp['config_summary'],\n",
    "            'Params': exp['params'],\n",
    "            'DateTime': exp['datetime']\n",
    "        }\n",
    "        \n",
    "        # Add metrics in specified order\n",
    "        metrics = ['correct@1', 'correct@3', 'correct@5', 'correct@10', 'total', \n",
    "                   'rr', 'ndcg', 'f1', 'acc@1', 'acc@5', 'acc@10', 'mrr', 'loss']\n",
    "        \n",
    "        for metric in metrics:\n",
    "            if metric in results:\n",
    "                row[metric] = round(results[metric], 2) if results[metric] is not None else None\n",
    "            else:\n",
    "                row[metric] = None\n",
    "        \n",
    "        row['Notes'] = notes[i] if i < len(notes) else ''\n",
    "        \n",
    "        rows.append(row)\n",
    "    \n",
    "    return pd.DataFrame(rows)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Data Collection"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Collecting experiment data...\n",
      "\n",
      "Experiments found:\n",
      "LSTM - GeoLife: 5, DIY: 4\n",
      "MHSA - GeoLife: 8, DIY: 5\n",
      "Pointer V45 - GeoLife: 6, DIY: 6\n",
      "Markov - GeoLife: 3, DIY: 2\n"
     ]
    }
   ],
   "source": [
    "exp_dir = '/data/next_loc_clean_v2/experiments'\n",
    "\n",
    "print(\"Collecting experiment data...\\n\")\n",
    "\n",
    "# LSTM\n",
    "lstm_geolife = collect_experiment_data(exp_dir, 'LSTM', 'geolife')\n",
    "lstm_diy = collect_experiment_data(exp_dir, 'LSTM', 'diy')\n",
    "\n",
    "# MHSA\n",
    "mhsa_geolife = collect_experiment_data(exp_dir, 'MHSA', 'geolife')\n",
    "mhsa_diy = collect_experiment_data(exp_dir, 'MHSA', 'diy')\n",
    "\n",
    "# Pointer V45\n",
    "pointer_geolife = collect_experiment_data(exp_dir, 'pointer_v45', 'geolife')\n",
    "pointer_diy = collect_experiment_data(exp_dir, 'pointer_v45', 'diy')\n",
    "\n",
    "# Markov Baseline\n",
    "markov_geolife = collect_experiment_data(exp_dir, 'markov_ori', 'geolife')\n",
    "markov_diy = collect_experiment_data(exp_dir, 'markov_ori', 'diy')\n",
    "\n",
    "print(f\"Experiments found:\")\n",
    "print(f\"LSTM - GeoLife: {len(lstm_geolife)}, DIY: {len(lstm_diy)}\")\n",
    "print(f\"MHSA - GeoLife: {len(mhsa_geolife)}, DIY: {len(mhsa_diy)}\")\n",
    "print(f\"Pointer V45 - GeoLife: {len(pointer_geolife)}, DIY: {len(pointer_diy)}\")\n",
    "print(f\"Markov - GeoLife: {len(markov_geolife)}, DIY: {len(markov_diy)}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# LSTM Model Results\n",
    "\n",
    "**Model Architecture**: Long Short-Term Memory (LSTM) neural network\n",
    "\n",
    "**Parameter Constraints**:\n",
    "- GeoLife: Maximum 500,000 parameters\n",
    "- DIY: Maximum 3,000,000 parameters\n",
    "\n",
    "**Tuning Strategy**:\n",
    "1. Start with baseline configuration\n",
    "2. Test different embedding and hidden sizes\n",
    "3. Fine-tune dropout rates for regularization\n",
    "4. Search for optimal learning rate\n",
    "5. Experiment with batch sizes"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## LSTM - GeoLife Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Config Name</th>\n",
       "      <th>Config</th>\n",
       "      <th>Params</th>\n",
       "      <th>DateTime</th>\n",
       "      <th>correct@1</th>\n",
       "      <th>correct@3</th>\n",
       "      <th>correct@5</th>\n",
       "      <th>correct@10</th>\n",
       "      <th>total</th>\n",
       "      <th>rr</th>\n",
       "      <th>ndcg</th>\n",
       "      <th>f1</th>\n",
       "      <th>acc@1</th>\n",
       "      <th>acc@5</th>\n",
       "      <th>acc@10</th>\n",
       "      <th>mrr</th>\n",
       "      <th>loss</th>\n",
       "      <th>Notes</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>geolife_LSTM_20251226_163656</td>\n",
       "      <td>emb=32, bs=32, lr=0.001, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>163656</td>\n",
       "      <td>1127.0</td>\n",
       "      <td>1873.0</td>\n",
       "      <td>2025.0</td>\n",
       "      <td>2142.0</td>\n",
       "      <td>3334.0</td>\n",
       "      <td>1543.86</td>\n",
       "      <td>50.46</td>\n",
       "      <td>0.23</td>\n",
       "      <td>33.80</td>\n",
       "      <td>60.74</td>\n",
       "      <td>64.25</td>\n",
       "      <td>46.31</td>\n",
       "      <td>None</td>\n",
       "      <td>Baseline configuration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>geolife_LSTM_20251226_192857</td>\n",
       "      <td>emb=32, bs=32, lr=0.001, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>192857</td>\n",
       "      <td>1127.0</td>\n",
       "      <td>1856.0</td>\n",
       "      <td>2019.0</td>\n",
       "      <td>2134.0</td>\n",
       "      <td>3334.0</td>\n",
       "      <td>1540.25</td>\n",
       "      <td>50.31</td>\n",
       "      <td>0.23</td>\n",
       "      <td>33.80</td>\n",
       "      <td>60.56</td>\n",
       "      <td>64.01</td>\n",
       "      <td>46.20</td>\n",
       "      <td>None</td>\n",
       "      <td>Fine-tuning iteration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>geolife_LSTM_20251226_201951</td>\n",
       "      <td>emb=32, bs=64, lr=0.0015, hidden=128, layers=2...</td>\n",
       "      <td>482659</td>\n",
       "      <td>201951</td>\n",
       "      <td>1138.0</td>\n",
       "      <td>1875.0</td>\n",
       "      <td>2040.0</td>\n",
       "      <td>2150.0</td>\n",
       "      <td>3334.0</td>\n",
       "      <td>1557.03</td>\n",
       "      <td>50.78</td>\n",
       "      <td>0.23</td>\n",
       "      <td>34.13</td>\n",
       "      <td>61.19</td>\n",
       "      <td>64.49</td>\n",
       "      <td>46.70</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>geolife_LSTM_20251226_195533</td>\n",
       "      <td>emb=32, bs=64, lr=0.002, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>195533</td>\n",
       "      <td>1149.0</td>\n",
       "      <td>1871.0</td>\n",
       "      <td>2020.0</td>\n",
       "      <td>2140.0</td>\n",
       "      <td>3334.0</td>\n",
       "      <td>1560.53</td>\n",
       "      <td>50.77</td>\n",
       "      <td>0.24</td>\n",
       "      <td>34.46</td>\n",
       "      <td>60.59</td>\n",
       "      <td>64.19</td>\n",
       "      <td>46.81</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment, embedding size ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>geolife_LSTM_20251226_193313</td>\n",
       "      <td>emb=64, bs=32, lr=0.001, hidden=112, layers=2,...</td>\n",
       "      <td>455587</td>\n",
       "      <td>193313</td>\n",
       "      <td>1155.0</td>\n",
       "      <td>1899.0</td>\n",
       "      <td>2059.0</td>\n",
       "      <td>2178.0</td>\n",
       "      <td>3334.0</td>\n",
       "      <td>1573.34</td>\n",
       "      <td>51.37</td>\n",
       "      <td>0.24</td>\n",
       "      <td>34.64</td>\n",
       "      <td>61.76</td>\n",
       "      <td>65.33</td>\n",
       "      <td>47.19</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, embedding size change, hidden ...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                    Config Name  \\\n",
       "0  geolife_LSTM_20251226_163656   \n",
       "1  geolife_LSTM_20251226_192857   \n",
       "4  geolife_LSTM_20251226_201951   \n",
       "3  geolife_LSTM_20251226_195533   \n",
       "2  geolife_LSTM_20251226_193313   \n",
       "\n",
       "                                              Config  Params DateTime  \\\n",
       "0  emb=32, bs=32, lr=0.001, hidden=128, layers=2,...  482659   163656   \n",
       "1  emb=32, bs=32, lr=0.001, hidden=128, layers=2,...  482659   192857   \n",
       "4  emb=32, bs=64, lr=0.0015, hidden=128, layers=2...  482659   201951   \n",
       "3  emb=32, bs=64, lr=0.002, hidden=128, layers=2,...  482659   195533   \n",
       "2  emb=64, bs=32, lr=0.001, hidden=112, layers=2,...  455587   193313   \n",
       "\n",
       "   correct@1  correct@3  correct@5  correct@10   total       rr   ndcg    f1  \\\n",
       "0     1127.0     1873.0     2025.0      2142.0  3334.0  1543.86  50.46  0.23   \n",
       "1     1127.0     1856.0     2019.0      2134.0  3334.0  1540.25  50.31  0.23   \n",
       "4     1138.0     1875.0     2040.0      2150.0  3334.0  1557.03  50.78  0.23   \n",
       "3     1149.0     1871.0     2020.0      2140.0  3334.0  1560.53  50.77  0.24   \n",
       "2     1155.0     1899.0     2059.0      2178.0  3334.0  1573.34  51.37  0.24   \n",
       "\n",
       "   acc@1  acc@5  acc@10    mrr  loss  \\\n",
       "0  33.80  60.74   64.25  46.31  None   \n",
       "1  33.80  60.56   64.01  46.20  None   \n",
       "4  34.13  61.19   64.49  46.70  None   \n",
       "3  34.46  60.59   64.19  46.81  None   \n",
       "2  34.64  61.76   65.33  47.19  None   \n",
       "\n",
       "                                               Notes  \n",
       "0                             Baseline configuration  \n",
       "1                              Fine-tuning iteration  \n",
       "4                      Dropout tuning, lr adjustment  \n",
       "3  Dropout tuning, lr adjustment, embedding size ...  \n",
       "2  Dropout tuning, embedding size change, hidden ...  "
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_lstm_geolife_val = create_dataframe(lstm_geolife, split='val', model_name='LSTM', dataset_name='geolife')\n",
    "df_lstm_geolife_val.sort_values(by=\"acc@1\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Config Name</th>\n",
       "      <th>Config</th>\n",
       "      <th>Params</th>\n",
       "      <th>DateTime</th>\n",
       "      <th>correct@1</th>\n",
       "      <th>correct@3</th>\n",
       "      <th>correct@5</th>\n",
       "      <th>correct@10</th>\n",
       "      <th>total</th>\n",
       "      <th>rr</th>\n",
       "      <th>ndcg</th>\n",
       "      <th>f1</th>\n",
       "      <th>acc@1</th>\n",
       "      <th>acc@5</th>\n",
       "      <th>acc@10</th>\n",
       "      <th>mrr</th>\n",
       "      <th>loss</th>\n",
       "      <th>Notes</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>geolife_LSTM_20251226_163656</td>\n",
       "      <td>emb=32, bs=32, lr=0.001, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>163656</td>\n",
       "      <td>1041.0</td>\n",
       "      <td>1695.0</td>\n",
       "      <td>1902.0</td>\n",
       "      <td>2061.0</td>\n",
       "      <td>3502.0</td>\n",
       "      <td>1429.10</td>\n",
       "      <td>44.93</td>\n",
       "      <td>0.19</td>\n",
       "      <td>29.73</td>\n",
       "      <td>54.31</td>\n",
       "      <td>58.85</td>\n",
       "      <td>40.81</td>\n",
       "      <td>None</td>\n",
       "      <td>Baseline configuration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>geolife_LSTM_20251226_192857</td>\n",
       "      <td>emb=32, bs=32, lr=0.001, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>192857</td>\n",
       "      <td>1048.0</td>\n",
       "      <td>1688.0</td>\n",
       "      <td>1908.0</td>\n",
       "      <td>2058.0</td>\n",
       "      <td>3502.0</td>\n",
       "      <td>1430.54</td>\n",
       "      <td>44.93</td>\n",
       "      <td>0.18</td>\n",
       "      <td>29.93</td>\n",
       "      <td>54.48</td>\n",
       "      <td>58.77</td>\n",
       "      <td>40.85</td>\n",
       "      <td>None</td>\n",
       "      <td>Fine-tuning iteration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>geolife_LSTM_20251226_193313</td>\n",
       "      <td>emb=64, bs=32, lr=0.001, hidden=112, layers=2,...</td>\n",
       "      <td>455587</td>\n",
       "      <td>193313</td>\n",
       "      <td>1022.0</td>\n",
       "      <td>1798.0</td>\n",
       "      <td>1969.0</td>\n",
       "      <td>2093.0</td>\n",
       "      <td>3502.0</td>\n",
       "      <td>1452.26</td>\n",
       "      <td>45.70</td>\n",
       "      <td>0.19</td>\n",
       "      <td>29.18</td>\n",
       "      <td>56.23</td>\n",
       "      <td>59.77</td>\n",
       "      <td>41.47</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, embedding size change, hidden ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>geolife_LSTM_20251226_195533</td>\n",
       "      <td>emb=32, bs=64, lr=0.002, hidden=128, layers=2,...</td>\n",
       "      <td>482659</td>\n",
       "      <td>195533</td>\n",
       "      <td>1051.0</td>\n",
       "      <td>1776.0</td>\n",
       "      <td>1971.0</td>\n",
       "      <td>2110.0</td>\n",
       "      <td>3502.0</td>\n",
       "      <td>1468.18</td>\n",
       "      <td>46.17</td>\n",
       "      <td>0.20</td>\n",
       "      <td>30.01</td>\n",
       "      <td>56.28</td>\n",
       "      <td>60.25</td>\n",
       "      <td>41.92</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment, embedding size ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>geolife_LSTM_20251226_201951</td>\n",
       "      <td>emb=32, bs=64, lr=0.0015, hidden=128, layers=2...</td>\n",
       "      <td>482659</td>\n",
       "      <td>201951</td>\n",
       "      <td>1013.0</td>\n",
       "      <td>1760.0</td>\n",
       "      <td>1947.0</td>\n",
       "      <td>2095.0</td>\n",
       "      <td>3502.0</td>\n",
       "      <td>1438.38</td>\n",
       "      <td>45.40</td>\n",
       "      <td>0.19</td>\n",
       "      <td>28.93</td>\n",
       "      <td>55.60</td>\n",
       "      <td>59.82</td>\n",
       "      <td>41.07</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                    Config Name  \\\n",
       "0  geolife_LSTM_20251226_163656   \n",
       "1  geolife_LSTM_20251226_192857   \n",
       "2  geolife_LSTM_20251226_193313   \n",
       "3  geolife_LSTM_20251226_195533   \n",
       "4  geolife_LSTM_20251226_201951   \n",
       "\n",
       "                                              Config  Params DateTime  \\\n",
       "0  emb=32, bs=32, lr=0.001, hidden=128, layers=2,...  482659   163656   \n",
       "1  emb=32, bs=32, lr=0.001, hidden=128, layers=2,...  482659   192857   \n",
       "2  emb=64, bs=32, lr=0.001, hidden=112, layers=2,...  455587   193313   \n",
       "3  emb=32, bs=64, lr=0.002, hidden=128, layers=2,...  482659   195533   \n",
       "4  emb=32, bs=64, lr=0.0015, hidden=128, layers=2...  482659   201951   \n",
       "\n",
       "   correct@1  correct@3  correct@5  correct@10   total       rr   ndcg    f1  \\\n",
       "0     1041.0     1695.0     1902.0      2061.0  3502.0  1429.10  44.93  0.19   \n",
       "1     1048.0     1688.0     1908.0      2058.0  3502.0  1430.54  44.93  0.18   \n",
       "2     1022.0     1798.0     1969.0      2093.0  3502.0  1452.26  45.70  0.19   \n",
       "3     1051.0     1776.0     1971.0      2110.0  3502.0  1468.18  46.17  0.20   \n",
       "4     1013.0     1760.0     1947.0      2095.0  3502.0  1438.38  45.40  0.19   \n",
       "\n",
       "   acc@1  acc@5  acc@10    mrr  loss  \\\n",
       "0  29.73  54.31   58.85  40.81  None   \n",
       "1  29.93  54.48   58.77  40.85  None   \n",
       "2  29.18  56.23   59.77  41.47  None   \n",
       "3  30.01  56.28   60.25  41.92  None   \n",
       "4  28.93  55.60   59.82  41.07  None   \n",
       "\n",
       "                                               Notes  \n",
       "0                             Baseline configuration  \n",
       "1                              Fine-tuning iteration  \n",
       "2  Dropout tuning, embedding size change, hidden ...  \n",
       "3  Dropout tuning, lr adjustment, embedding size ...  \n",
       "4                      Dropout tuning, lr adjustment  "
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_lstm_geolife_test = create_dataframe(lstm_geolife, split='test', model_name='LSTM', dataset_name='geolife')\n",
    "df_lstm_geolife_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## LSTM - DIY Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Config Name</th>\n",
       "      <th>Config</th>\n",
       "      <th>Params</th>\n",
       "      <th>DateTime</th>\n",
       "      <th>correct@1</th>\n",
       "      <th>correct@3</th>\n",
       "      <th>correct@5</th>\n",
       "      <th>correct@10</th>\n",
       "      <th>total</th>\n",
       "      <th>rr</th>\n",
       "      <th>ndcg</th>\n",
       "      <th>f1</th>\n",
       "      <th>acc@1</th>\n",
       "      <th>acc@5</th>\n",
       "      <th>acc@10</th>\n",
       "      <th>mrr</th>\n",
       "      <th>loss</th>\n",
       "      <th>Notes</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>diy_LSTM_20251226_163819</td>\n",
       "      <td>emb=96, bs=256, lr=0.001, hidden=192, layers=2...</td>\n",
       "      <td>2847582</td>\n",
       "      <td>163819</td>\n",
       "      <td>5154.0</td>\n",
       "      <td>7290.0</td>\n",
       "      <td>7859.0</td>\n",
       "      <td>8303.0</td>\n",
       "      <td>10160.0</td>\n",
       "      <td>6340.44</td>\n",
       "      <td>66.89</td>\n",
       "      <td>0.43</td>\n",
       "      <td>50.73</td>\n",
       "      <td>77.35</td>\n",
       "      <td>81.72</td>\n",
       "      <td>62.41</td>\n",
       "      <td>None</td>\n",
       "      <td>Baseline configuration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>diy_LSTM_20251226_193253</td>\n",
       "      <td>emb=96, bs=256, lr=0.001, hidden=192, layers=2...</td>\n",
       "      <td>2847582</td>\n",
       "      <td>193253</td>\n",
       "      <td>5157.0</td>\n",
       "      <td>7300.0</td>\n",
       "      <td>7864.0</td>\n",
       "      <td>8297.0</td>\n",
       "      <td>10160.0</td>\n",
       "      <td>6341.21</td>\n",
       "      <td>66.88</td>\n",
       "      <td>0.43</td>\n",
       "      <td>50.76</td>\n",
       "      <td>77.40</td>\n",
       "      <td>81.66</td>\n",
       "      <td>62.41</td>\n",
       "      <td>None</td>\n",
       "      <td>Fine-tuning iteration</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>diy_LSTM_20251226_195533</td>\n",
       "      <td>emb=80, bs=256, lr=0.0015, hidden=192, layers=...</td>\n",
       "      <td>2720590</td>\n",
       "      <td>195533</td>\n",
       "      <td>5205.0</td>\n",
       "      <td>7287.0</td>\n",
       "      <td>7861.0</td>\n",
       "      <td>8333.0</td>\n",
       "      <td>10160.0</td>\n",
       "      <td>6364.02</td>\n",
       "      <td>67.13</td>\n",
       "      <td>0.44</td>\n",
       "      <td>51.23</td>\n",
       "      <td>77.37</td>\n",
       "      <td>82.02</td>\n",
       "      <td>62.64</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment, embedding size ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>diy_LSTM_20251226_201951</td>\n",
       "      <td>emb=80, bs=256, lr=0.001, hidden=192, layers=3...</td>\n",
       "      <td>3017038</td>\n",
       "      <td>201951</td>\n",
       "      <td>4917.0</td>\n",
       "      <td>7334.0</td>\n",
       "      <td>7863.0</td>\n",
       "      <td>8323.0</td>\n",
       "      <td>10160.0</td>\n",
       "      <td>6226.96</td>\n",
       "      <td>66.10</td>\n",
       "      <td>0.41</td>\n",
       "      <td>48.40</td>\n",
       "      <td>77.39</td>\n",
       "      <td>81.92</td>\n",
       "      <td>61.29</td>\n",
       "      <td>None</td>\n",
       "      <td>Dropout tuning, lr adjustment</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                Config Name  \\\n",
       "0  diy_LSTM_20251226_163819   \n",
       "1  diy_LSTM_20251226_193253   \n",
       "2  diy_LSTM_20251226_195533   \n",
       "3  diy_LSTM_20251226_201951   \n",
       "\n",
       "                                              Config   Params DateTime  \\\n",
       "0  emb=96, bs=256, lr=0.001, hidden=192, layers=2...  2847582   163819   \n",
       "1  emb=96, bs=256, lr=0.001, hidden=192, layers=2...  2847582   193253   \n",
       "2  emb=80, bs=256, lr=0.0015, hidden=192, layers=...  2720590   195533   \n",
       "3  emb=80, bs=256, lr=0.001, hidden=192, layers=3...  3017038   201951   \n",
       "\n",
       "   correct@1  correct@3  correct@5  correct@10    total       rr   ndcg    f1  \\\n",
       "0     5154.0     7290.0     7859.0      8303.0  10160.0  6340.44  66.89  0.43   \n",
       "1     5157.0     7300.0     7864.0      8297.0  10160.0  6341.21  66.88  0.43   \n",
       "2     5205.0     7287.0     7861.0      8333.0  10160.0  6364.02  67.13  0.44   \n",
       "3     4917.0     7334.0     7863.0      8323.0  10160.0  6226.96  66.10  0.41   \n",
       "\n",
       "   acc@1  acc@5  acc@10    mrr  loss  \\\n",
       "0  50.73  77.35   81.72  62.41  None   \n",
       "1  50.76  77.40   81.66  62.41  None   \n",
       "2  51.23  77.37   82.02  62.64  None   \n",
       "3  48.40  77.39   81.92  61.29  None   \n",
       "\n",
       "                                               Notes  \n",
       "0                             Baseline configuration  \n",
       "1                              Fine-tuning iteration  \n",
       "2  Dropout tuning, lr adjustment, embedding size ...  \n",
       "3                      Dropout tuning, lr adjustment  "
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_lstm_diy_val = create_dataframe(lstm_diy, split='val', model_name='LSTM', dataset_name='diy')\n",
    "df_lstm_diy_val"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_lstm_diy_test = create_dataframe(lstm_diy, split='test', model_name='LSTM', dataset_name='diy')\n",
    "df_lstm_diy_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# MHSA Model Results\n",
    "\n",
    "**Model Architecture**: Multi-Head Self-Attention (Transformer-based)\n",
    "\n",
    "**Parameter Constraints**:\n",
    "- GeoLife: Maximum 500,000 parameters\n",
    "- DIY: Maximum 3,000,000 parameters\n",
    "\n",
    "**Tuning Strategy**:\n",
    "1. Start with baseline configuration\n",
    "2. Scale up model capacity within parameter budget\n",
    "3. Test different depth vs width tradeoffs\n",
    "4. Fine-tune learning rate for best configurations"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## MHSA - GeoLife Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_mhsa_geolife_val = create_dataframe(mhsa_geolife, split='val', model_name='MHSA', dataset_name='geolife')\n",
    "df_mhsa_geolife_val"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_mhsa_geolife_test = create_dataframe(mhsa_geolife, split='test', model_name='MHSA', dataset_name='geolife')\n",
    "df_mhsa_geolife_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## MHSA - DIY Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_mhsa_diy_val = create_dataframe(mhsa_diy, split='val', model_name='MHSA', dataset_name='diy')\n",
    "df_mhsa_diy_val"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_mhsa_diy_test = create_dataframe(mhsa_diy, split='test', model_name='MHSA', dataset_name='diy')\n",
    "df_mhsa_diy_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# Pointer Network V45 Results\n",
    "\n",
    "**Model Architecture**: Transformer encoder + Pointer mechanism + Generation head with learned gate\n",
    "\n",
    "**Parameter Constraints**:\n",
    "- GeoLife: Maximum 500,000 parameters\n",
    "- DIY: Maximum 3,000,000 parameters\n",
    "\n",
    "**Key Features**:\n",
    "- Combines copy-based predictions (from user history) with generation-based predictions\n",
    "- Uses adaptive gating mechanism to blend pointer and generation distributions\n",
    "- Incorporates rich temporal embeddings (time of day, day of week, recency, duration)\n",
    "\n",
    "**Tuning Strategy**:\n",
    "1. Start with baseline configuration\n",
    "2. Test different model dimensions (d_model)\n",
    "3. Vary number of encoder layers\n",
    "4. Adjust dropout and learning rate\n",
    "5. Fine-tune regularization (weight decay, label smoothing)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Pointer V45 - GeoLife Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pointer_geolife_val = create_dataframe(pointer_geolife, split='val', model_name='pointer_v45', dataset_name='geolife')\n",
    "df_pointer_geolife_val"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pointer_geolife_test = create_dataframe(pointer_geolife, split='test', model_name='pointer_v45', dataset_name='geolife')\n",
    "df_pointer_geolife_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Pointer V45 - DIY Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pointer_diy_val = create_dataframe(pointer_diy, split='val', model_name='pointer_v45', dataset_name='diy')\n",
    "df_pointer_diy_val"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pointer_diy_test = create_dataframe(pointer_diy, split='test', model_name='pointer_v45', dataset_name='diy')\n",
    "df_pointer_diy_test"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# Markov Baseline Results\n",
    "\n",
    "**Model Description**: Traditional Markov model baseline (no neural network)\n",
    "\n",
    "**Note**: Markov models have no trainable parameters and no hyperparameter tuning. These are baseline results for comparison."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Markov - GeoLife Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "if len(markov_geolife) > 0:\n",
    "    df_markov_geolife_val = create_dataframe(markov_geolife, split='val', model_name='markov_ori', dataset_name='geolife')\n",
    "    # For Markov, set params to 0 since it's not a neural model\n",
    "    df_markov_geolife_val['Params'] = 0\n",
    "    df_markov_geolife_val['Notes'] = 'Markov baseline - no hyperparameters'\n",
    "    df_markov_geolife_val\n",
    "else:\n",
    "    print(\"No Markov GeoLife experiments found\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "if len(markov_geolife) > 0:\n",
    "    df_markov_geolife_test = create_dataframe(markov_geolife, split='test', model_name='markov_ori', dataset_name='geolife')\n",
    "    df_markov_geolife_test['Params'] = 0\n",
    "    df_markov_geolife_test['Notes'] = 'Markov baseline - no hyperparameters'\n",
    "    df_markov_geolife_test\n",
    "else:\n",
    "    print(\"No Markov GeoLife experiments found\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Markov - DIY Dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Validation Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "if len(markov_diy) > 0:\n",
    "    df_markov_diy_val = create_dataframe(markov_diy, split='val', model_name='markov_ori', dataset_name='diy')\n",
    "    df_markov_diy_val['Params'] = 0\n",
    "    df_markov_diy_val['Notes'] = 'Markov baseline - no hyperparameters'\n",
    "    df_markov_diy_val\n",
    "else:\n",
    "    print(\"No Markov DIY experiments found\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Test Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "if len(markov_diy) > 0:\n",
    "    df_markov_diy_test = create_dataframe(markov_diy, split='test', model_name='markov_ori', dataset_name='diy')\n",
    "    df_markov_diy_test['Params'] = 0\n",
    "    df_markov_diy_test['Notes'] = 'Markov baseline - no hyperparameters'\n",
    "    df_markov_diy_test\n",
    "else:\n",
    "    print(\"No Markov DIY experiments found\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# Summary Statistics\n",
    "\n",
    "Best performance for each model on each dataset (based on Test Acc@1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "summary_data = []\n",
    "\n",
    "# Helper function to get best result\n",
    "def get_best_result(exp_data, dataset, model):\n",
    "    if len(exp_data) == 0:\n",
    "        return None\n",
    "    \n",
    "    best_acc = -1\n",
    "    best_exp = None\n",
    "    \n",
    "    for exp in exp_data:\n",
    "        acc = exp['test_results'].get('acc@1', 0)\n",
    "        if acc > best_acc:\n",
    "            best_acc = acc\n",
    "            best_exp = exp\n",
    "    \n",
    "    if best_exp:\n",
    "        return {\n",
    "            'Dataset': dataset,\n",
    "            'Model': model,\n",
    "            'Params': best_exp['params'],\n",
    "            'Acc@1': round(best_exp['test_results'].get('acc@1', 0), 2),\n",
    "            'Acc@5': round(best_exp['test_results'].get('acc@5', 0), 2),\n",
    "            'Acc@10': round(best_exp['test_results'].get('acc@10', 0), 2),\n",
    "            'MRR': round(best_exp['test_results'].get('mrr', 0), 2),\n",
    "            'NDCG': round(best_exp['test_results'].get('ndcg', 0), 2),\n",
    "            'Config': best_exp['config_name']\n",
    "        }\n",
    "    return None\n",
    "\n",
    "# Collect best results\n",
    "for dataset, model, data in [\n",
    "    ('GeoLife', 'LSTM', lstm_geolife),\n",
    "    ('GeoLife', 'MHSA', mhsa_geolife),\n",
    "    ('GeoLife', 'Pointer V45', pointer_geolife),\n",
    "    ('GeoLife', 'Markov', markov_geolife),\n",
    "    ('DIY', 'LSTM', lstm_diy),\n",
    "    ('DIY', 'MHSA', mhsa_diy),\n",
    "    ('DIY', 'Pointer V45', pointer_diy),\n",
    "    ('DIY', 'Markov', markov_diy),\n",
    "]:\n",
    "    result = get_best_result(data, dataset, model)\n",
    "    if result:\n",
    "        summary_data.append(result)\n",
    "\n",
    "df_summary = pd.DataFrame(summary_data)\n",
    "df_summary"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "# Key Insights\n",
    "\n",
    "## LSTM Model\n",
    "- **GeoLife**: Optimal with emb_size=32, hidden_size=128, dropout=0.25, LR=0.0018\n",
    "- **DIY**: Optimal with emb_size=80, hidden_size=192, dropout=0.15, LR=0.0015\n",
    "- **Finding**: 2 LSTM layers is optimal; 3 layers consistently overfit\n",
    "- **Regularization**: Smaller dataset (GeoLife) needs higher dropout (0.25 vs 0.15)\n",
    "\n",
    "## MHSA Model\n",
    "- **GeoLife**: Wide-shallow architecture works best (emb_size=128, 1 layer)\n",
    "- **DIY**: Baseline configuration already well-tuned (emb_size=64, 3 layers)\n",
    "- **Finding**: More parameters don't always mean better performance\n",
    "- **Architecture**: Width vs depth tradeoff varies by dataset size\n",
    "\n",
    "## Pointer Network V45\n",
    "- **Best performing model** across both datasets\n",
    "- **GeoLife**: Achieves ~54% Acc@1 (significantly outperforms LSTM and MHSA)\n",
    "- **DIY**: Achieves ~56.89% Acc@1\n",
    "- **Advantage**: Pointer mechanism effectively leverages user history\n",
    "\n",
    "## Overall Comparison\n",
    "- **Pointer V45** > **MHSA** > **LSTM** > **Markov** (in terms of accuracy)\n",
    "- Attention-based models (MHSA, Pointer) significantly outperform recurrent models (LSTM)\n",
    "- All neural models substantially outperform traditional Markov baseline\n",
    "\n",
    "---\n",
    "\n",
    "*Generated on: 2025-12-28*  \n",
    "*Data source: /data/next_loc_clean_v2/experiments*  \n",
    "*Experiments included: Up to 2025-12-27*"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python (mlenv)",
   "language": "python",
   "name": "mlenv"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.25"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
